% collectResults.m collects the results stored in a common folder.
%
% USAGE:
% ======
% [parameters] = collectResults(foldername)
%
% INPUTS:
% =======
% foldername ... name of folder from which results are collected.
%
% Outputs:
% ========
% parameters ... parameter struct.
%
% 2014/06/12 Jan Hasenauer

function obj = collectResults(foldername)

%% Initialization
warning off;
try
    init = load([foldername '/init'],'parameters');
    obj = init.parameters;
    type = 'parameters';
catch
    init = load([foldername '/init'],'properties');
    obj = init.properties;
    type = 'properties';
end
warning on;

%% Collection of data
files = dir(fullfile(foldername,'*.csv'));

ntheta = size(init.parameters.MS.par0,1);
nstarts = init.parameters.MS.n_starts;

obj.MS.logPost = NaN(nstarts,1);
obj.MS.logPost0 = NaN(nstarts,1);
obj.MS.par = NaN(ntheta,nstarts);
obj.MS.par0 = NaN(ntheta,nstarts);
obj.MS.gradient = NaN(ntheta,nstarts);
obj.MS.hessian = NaN(ntheta,ntheta,nstarts);
obj.MS.t_cpu = NaN(nstarts,1);
obj.MS.n_objfun = NaN(nstarts,1);
obj.MS.n_iter = NaN(nstarts,1);
obj.MS.exitflag = NaN(nstarts,1);


% Loop: files
for j = 1:length(files)
    % Read file
    v = csvread([foldername '/' files(j).name]);
    
    % Determine index and fieldname
    fn1 = files(j).name(1);
    fn2 = files(j).name((strfind(files(j).name,'__')+2):(length(files(j).name)-4));

    % Assignment
    switch fn1
        case 'M' % -> Multi-start optimization results
            i = str2num(files(j).name(3:(strfind(files(j).name,'__')-1)));
            switch fn2
                case 'logPost', obj.MS.logPost(i,1) = v;
                case 'logPost0', obj.MS.logPost0(i,1) = v;
                case 'par', obj.MS.par(:,i) = v;
                case 'par0', obj.MS.par0(:,i) = v;
                case 'gradient', obj.MS.gradient(:,i) = v;            
                case 'hessian', obj.MS.hessian(:,:,i) = v;
                case 't_cpu', obj.MS.t_cpu(i,1) = v;
                case 'n_objfun', obj.MS.n_objfun(i,1) = v;
                case 'n_iter', obj.MS.n_iter(i,1) = v;
                case 'exitflag', obj.MS.exitflag(i,1) = v;
                case 'prop', obj.MS.prop(:,i) = v;
                case 'prop_Sigma', obj.MS.prop_Sigma(:,:,i) = v;
            end
        case 'P' % -> Profile calculation results
            i = str2num(files(j).name(2:(strfind(files(j).name,'__')-1)));
            switch fn2
                case 'par', obj.P(i).par = v;
                case 'logPost', obj.P(i).logPost = v;
                case 'R', obj.P(i).R = v;
                case 'exitflag', obj.P(i).exitflag = v;
                case 'prop', obj.P(i).prop = v;
            end
   end
end

%% Sort and save results 
switch type
    case 'parameters'
        parameters = sortMultiStarts(obj);
        % save([foldername '/result'],'parameters');
end

%% Visualization
switch type
    case 'parameters'
        if isfield(obj,'MS')
            disp(['progress of MS = ' num2str(100*sum(~isnan(parameters.MS.par(1,:)))/parameters.MS.n_starts) '%']);
            plotMultiStarts(obj);
        end
        if isfield(obj,'P')
            plotParameterProfiles(obj);
        end
    case 'properties'
        if isfield(obj,'MS')
            plotPropertyMultiStarts(obj);
        end
        if isfield(obj,'P')
            plotPropertyProfiles(obj);
        end
end